---

# Get a keycloak token (sets the fact 'kc_token').
# Remember that the login user may have changed to admin.

- include_tasks: get-keycloak-token.yml
  vars:
    realm: "{{ kc_realm }}"
    realm_user: "{{ kc_manager_fact }}"
    realm_user_password: "{{ kc_manager_password_fact }}"

# Adding keycloak roles.
# The steps here are: -
#
# 1. Get a list of roles using the 'users_file'
#    that are already known (this might be nobody)
# 2. Add all the users from the 'users_file' that aren't known
# 3. Get user identities for all the users in the users_file
# 4. Set (reset) passwords for all the users that were added in step 2.

- name: Set API endpoint
  set_fact:
    keycloak_endpoint: https://{{ kc_hostname }}/auth/admin/realms/{{ kc_realm }}

#####
# 1 #
#####
#
# Get a list of roles that are already known.

- name: Get exisiting Realm Roles ({{ kc_realm }})
  uri:
    url: "{{ keycloak_endpoint }}/roles"
    headers:
      Authorization: bearer {{ kc_token }}
  register: realm_roles
  changed_when: False

# The above 'query' results in a `realm_roles' variable. A structure
# with each query represented as an element in the 'json' array.
# i.e.
#
#  "json": [{
#    "name": "standard-user"
#
# To simplify further processing, we'd like a nice flat list.
- name: Collect known Roles
  set_fact:
    known_roles: "{{ realm_roles|json_query('json[*].name')|flatten }}"
  changed_when: False

#####
# 2 #
#####
#
# Now, add all the roles we need.

- name: Add Roles (that do not exist)
  uri:
    url: "{{ keycloak_endpoint }}/roles"
    method: POST
    body: >-
      {"name": "{{ item }}"}
    body_format: json
    status_code: 201
    headers:
      Authorization: bearer {{ kc_token }}
  with_items:
  - "{{ kc_default_roles }}"
  when:
  - item not in known_roles

#####
# 3 #
#####
#
# Update the top-level Realm Representation
# which contains the array of 'default roles'.
#
# To do this we:
# -   Get the current representation
# -   Collect the default roles from it
# -   Extend the list of default roles
# -   Update the role Representation by putting the array back

- name: Get the top-level Realm Representation
  uri:
    url: "{{ keycloak_endpoint }}"
    headers:
      Authorization: bearer {{ kc_token }}
  register: realm_representation
  changed_when: False

- name: Collect known Default Roles
  set_fact:
    known_default_roles: "{{ realm_representation|json_query('json.defaultRoles') }}"
  changed_when: False

- name: Extend Realm Representation Default Roles
  set_fact:
    known_default_roles: "{{ known_default_roles }} + [ '{{ item }}' ]"
  with_items:
  - "{{ kc_default_roles }}"
  when: item not in known_default_roles
  changed_when: False

- name: Update Realm Representation
  uri:
    url: "{{ keycloak_endpoint }}"
    method: PUT
    body: >-
      {"defaultRoles": {{ known_default_roles }}}
    body_format: json
    status_code: 204
    headers:
      Authorization: bearer {{ kc_token }}
